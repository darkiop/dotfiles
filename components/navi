#!/bin/bash

# load shell widget for navi (STRG + G)
if ! command -v navi >/dev/null 2>&1; then
	for navi_bin in /opt/homebrew/bin/navi /usr/local/bin/navi; do
		if [[ -x "${navi_bin}" ]]; then
			export PATH="${PATH:+${PATH}:}$(dirname "${navi_bin}")"
			break
		fi
	done
fi

if command -v navi >/dev/null 2>&1; then
	cheats_dir="${DOTFILES_CHEATS_DIR:-$HOME/dotfiles/cheats}"
	if [[ -d "${cheats_dir}" && ":${NAVI_PATH:-}:" != *":${cheats_dir}:"* ]]; then
		export NAVI_PATH="${cheats_dir}${NAVI_PATH:+:${NAVI_PATH}}"
	fi

	# navi uses fzf by default; make sure the dotfiles-managed fzf is on PATH.
	if ! command -v fzf >/dev/null 2>&1; then
		if command -v ADD_TO_PATH >/dev/null 2>&1; then
			ADD_TO_PATH "$HOME/.fzf/bin"
			ADD_TO_PATH "$HOME/dotfiles/modules/fzf/bin"
		else
			[[ -d "$HOME/.fzf/bin" && ":${PATH:-}:" != *":$HOME/.fzf/bin:"* ]] && export PATH="${PATH:+${PATH}:}$HOME/.fzf/bin"
			[[ -d "$HOME/dotfiles/modules/fzf/bin" && ":${PATH:-}:" != *":$HOME/dotfiles/modules/fzf/bin:"* ]] && export PATH="${PATH:+${PATH}:}$HOME/dotfiles/modules/fzf/bin"
		fi
	fi

	# Load navi widget with caching (P021 optimization)
	# Widget output is static, so we cache it and only regenerate when navi binary changes
	_navi_load_widget() {
		local shell_type="$1"
		local cache_dir="${HOME}/.cache/dotfiles"
		local cache_file="${cache_dir}/navi-widget-${shell_type}"
		local navi_bin
		navi_bin="$(command -v navi)"

		# Check if cache is valid (exists and newer than navi binary)
		if [[ -f ${cache_file} ]]; then
			local cache_mtime navi_mtime
			cache_mtime=$(stat -c %Y "${cache_file}" 2>/dev/null || stat -f %m "${cache_file}" 2>/dev/null || echo 0)
			navi_mtime=$(stat -c %Y "${navi_bin}" 2>/dev/null || stat -f %m "${navi_bin}" 2>/dev/null || echo 0)
			if [[ ${cache_mtime} -ge ${navi_mtime} ]]; then
				# Cache is valid, source it
				source "${cache_file}"
				return 0
			fi
		fi

		# Cache miss or stale - regenerate
		mkdir -p "${cache_dir}" 2>/dev/null || true
		if navi widget "${shell_type}" > "${cache_file}" 2>/dev/null; then
			source "${cache_file}"
		else
			# Fallback to direct eval if caching fails
			eval "$(navi widget "${shell_type}" || true)" 2>/dev/null
		fi
	}

	if [[ -n ${BASH_VERSION:-} ]]; then
		_navi_load_widget bash
	elif [[ -n ${ZSH_VERSION:-} ]]; then
		_navi_load_widget zsh
	fi

	unset -f _navi_load_widget
fi
