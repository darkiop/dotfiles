#!/bin/bash

# Small fzf-powered helpers (bash + zsh).
# Enabled via DOTFILES_ENABLE_FZF_EXTRAS.

case $- in
*i*) ;;
*) return ;;
esac

command -v fzf >/dev/null 2>&1 || return 0

dotfiles_fzf_extras__fzf() {
	fzf --ansi --layout=reverse --border "$@"
}

dotfiles_fzf_history__reverse_unique() {
	# Read lines on stdin, output in reverse order, removing duplicates (keep newest).
	awk '
		{ a[NR] = $0 }
		END {
			for (i = NR; i >= 1; i--) {
				line = a[i]
				if (line == "") continue
				if (!seen[line]++) print line
			}
		}
	'
}

dotfiles_fzf_history__select_bash() {
	# Strip leading history number and whitespace; suppress HISTTIMEFORMAT output.
	HISTTIMEFORMAT= builtin history |
		sed -E 's/^[[:space:]]*[0-9]+[[:space:]]+//' |
		dotfiles_fzf_history__reverse_unique |
		dotfiles_fzf_extras__fzf --prompt='history> '
}

dotfiles_fzf_history__select_zsh() {
	# `fc -rl 1`: reverse list (newest first), with event numbers.
	fc -rl 1 2>/dev/null |
		sed -E 's/^[[:space:]]*[0-9]+[[:space:]]+//' |
		awk 'NF' |
		awk '!seen[$0]++' |
		dotfiles_fzf_extras__fzf --prompt='history> '
}

dotfiles_fzf_history__bindings_enabled() {
	if type dotfiles_flag_enabled >/dev/null 2>&1; then
		dotfiles_flag_enabled DOTFILES_ENABLE_FZF_HISTORY_BINDINGS
		return $?
	fi
	case "${DOTFILES_ENABLE_FZF_HISTORY_BINDINGS:-}" in
	1 | true | TRUE | yes | YES | y | Y | on | ON) return 0 ;;
	*) return 1 ;;
	esac
}

dotfiles_fzf_history__install_bindings_bash() {
	dotfiles_fzf_history__bindings_enabled || return 0

	dotfiles_fzf_history_widget() {
		local picked=""
		picked="$(dotfiles_fzf_history__select_bash)" || return 0
		[[ -n "${picked}" ]] || return 0
		READLINE_LINE="${picked}"
		READLINE_POINT="${#READLINE_LINE}"
	}

	# Replace reverse-i-search with fzf history picker.
	bind -x '"\C-r":dotfiles_fzf_history_widget' 2>/dev/null || true
}

dotfiles_fzf_history__install_bindings_zsh() {
	dotfiles_fzf_history__bindings_enabled || return 0

	dotfiles_fzf_history_widget() {
		local picked=""
		picked="$(dotfiles_fzf_history__select_zsh)" || return 0
		[[ -n "${picked}" ]] || return 0
		BUFFER="${picked}"
		CURSOR="${#BUFFER}"
		zle redisplay
	}

	zle -N dotfiles_fzf_history_widget 2>/dev/null || return 0
	bindkey '^R' dotfiles_fzf_history_widget 2>/dev/null || true
}

fh() {
	local picked=""

	if [[ -n ${BASH_VERSION:-} ]]; then
		picked="$(dotfiles_fzf_history__select_bash)" || return 1
	elif [[ -n ${ZSH_VERSION:-} ]]; then
		picked="$(dotfiles_fzf_history__select_zsh)" || return 1
	else
		return 1
	fi

	[[ -n "${picked}" ]] || return 1

	# If invoked via `bind -x` in bash, insert into the current readline buffer.
	if [[ -n ${BASH_VERSION:-} && -n ${READLINE_LINE+x} ]]; then
		READLINE_LINE="${picked}"
		READLINE_POINT="${#READLINE_LINE}"
		return 0
	fi

	# Otherwise print it (zsh cannot edit the current buffer from a normal function).
	printf '%s\n' "${picked}"
}

if [[ -n ${BASH_VERSION:-} ]]; then
	dotfiles_fzf_history__install_bindings_bash
elif [[ -n ${ZSH_VERSION:-} ]]; then
	dotfiles_fzf_history__install_bindings_zsh
fi
