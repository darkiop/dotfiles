#!/bin/bash

case $- in
*i*) ;;
*) return ;;
esac

# enable programmable completion features (you don't need to enable this, if it's already enabled in /etc/bash.bashrc and /etc/profile sources /etc/bash.bashrc).
if ! shopt -oq posix; then
	if [[ -f /usr/share/bash-completion/bash_completion ]]; then
		source /usr/share/bash-completion/bash_completion
	elif [[ -f /etc/bash_completion ]]; then
		source /etc/bash_completion
	fi
fi

# load scripts in bash_completion.d
if [[ -d "${HOME}/dotfiles/bash_completion.d" ]]; then
	shopt -s nullglob
	dotfiles_completion_scripts=("${HOME}/dotfiles/bash_completion.d/"*)
	shopt -u nullglob
	for f in "${dotfiles_completion_scripts[@]}"; do
		# trunk-ignore(shellcheck/SC1090)
		source "${f}"
	done
fi

# create bash_completion for hcloud (cached; do not write into repo)
if command -v hcloud >/dev/null 2>&1; then
	dotfiles_completion_cache_dir="${HOME}/.cache/dotfiles/completions"
	dotfiles_hcloud_completion_file="${dotfiles_completion_cache_dir}/hcloud.bash"
	dotfiles_hcloud_version_file="${dotfiles_completion_cache_dir}/hcloud.version"

	mkdir -p "${dotfiles_completion_cache_dir}" 2>/dev/null || true

	dotfiles_hcloud_current_version="$(hcloud version 2>/dev/null | tr -d '\r')"
	dotfiles_hcloud_cached_version=""
	if [[ -f "${dotfiles_hcloud_version_file}" ]]; then
		dotfiles_hcloud_cached_version="$(<"${dotfiles_hcloud_version_file}")"
	fi

	if [[ ! -f "${dotfiles_hcloud_completion_file}" || "${dotfiles_hcloud_cached_version}" != "${dotfiles_hcloud_current_version}" ]]; then
		dotfiles_hcloud_tmp="${dotfiles_hcloud_completion_file}.tmp.$$"
		if hcloud completion bash >"${dotfiles_hcloud_tmp}" 2>/dev/null; then
			mv -f -- "${dotfiles_hcloud_tmp}" "${dotfiles_hcloud_completion_file}"
			printf '%s' "${dotfiles_hcloud_current_version}" >"${dotfiles_hcloud_version_file}"
		else
			rm -f -- "${dotfiles_hcloud_tmp}" 2>/dev/null || true
		fi
	fi

	# shellcheck source=/dev/null
	[[ -f "${dotfiles_hcloud_completion_file}" ]] && source "${dotfiles_hcloud_completion_file}"
fi

# Enable Tab-Completion for sudo
complete -cf sudo
